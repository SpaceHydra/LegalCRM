<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal CRM Portal - Manage Matter Advocates</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="logo-section">
            <div class="logo">LC</div>
            <div class="system-title">
                <h1>Legal CRM Portal</h1>
                <p>SNG & Partners - Business Development Platform</p>
            </div>
        </div>
        <div class="user-section">
            <div class="user-profile">
                <div class="user-avatar">PM</div>
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Prateek Mehta</div>
                    <div style="font-size: 11px; opacity: 0.8;">Senior Advocate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="nav-section">
            <div class="nav-section-title">Matter Management</div>
            <a href="matter-list.html" class="nav-item">
                <div class="nav-icon">‚öñÔ∏è</div>
                <div class="nav-label">Matters</div>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div style="margin-bottom: 16px;">
            <a href="#" onclick="goBack()" style="color: #64748b; text-decoration: none;">‚Üê Back to Matter Details</a>
        </div>

        <div class="page-header">
            <div>
                <h2 id="pageTitle">Manage Advocates</h2>
                <p id="matterInfo">Assign and manage advocates for this matter</p>
            </div>
            <button onclick="showAddAdvocateForm()" class="btn-primary">+ Add Advocate</button>
        </div>

        <!-- Add Advocate Form (Initially Hidden) -->
        <div id="addAdvocateForm" style="display: none; margin-bottom: 24px;">
            <div class="card">
                <div class="card-header">
                    <h3>Add New Advocate Assignment</h3>
                </div>
                <div class="card-body">
                    <form id="advocateForm" onsubmit="saveAdvocate(event)">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div class="form-group">
                                <label>Advocate Name *</label>
                                <input type="text" id="advocateName" class="form-control" required placeholder="e.g., Advocate Rajesh Kumar">
                            </div>

                            <div class="form-group">
                                <label>Role *</label>
                                <select id="advocateRole" class="form-control" required>
                                    <option value="">Select Role</option>
                                    <option value="Primary">Primary Advocate</option>
                                    <option value="Junior">Junior Advocate</option>
                                    <option value="External">External Counsel</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="advocateEmail" class="form-control" placeholder="advocate@example.com">
                            </div>

                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="advocatePhone" class="form-control" placeholder="+91 98765 43210">
                            </div>

                            <div class="form-group">
                                <label>Practice Area</label>
                                <select id="practiceArea" class="form-control">
                                    <option value="">Select Practice Area</option>
                                    <option value="Banking & Finance">Banking & Finance</option>
                                    <option value="Recovery">Recovery & Enforcement</option>
                                    <option value="Title Verification">Title Verification</option>
                                    <option value="Corporate">Corporate & Commercial</option>
                                    <option value="Litigation">Litigation</option>
                                    <option value="Real Estate">Real Estate</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Assignment Date</label>
                                <input type="date" id="assignmentDate" class="form-control">
                            </div>

                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Scope of Work</label>
                                <textarea id="scopeOfWork" class="form-control" rows="3" placeholder="Describe the specific responsibilities and scope..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="isPrimary">
                                    Mark as Primary Responsible Advocate
                                </label>
                            </div>
                        </div>

                        <div style="margin-top: 16px; display: flex; gap: 12px;">
                            <button type="submit" class="btn-primary">üíæ Save Advocate</button>
                            <button type="button" onclick="hideAddAdvocateForm()" class="btn-secondary">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Current Advocates List -->
        <div class="card">
            <div class="card-header">
                <h3>Current Advocate Assignments</h3>
            </div>
            <div class="card-body">
                <div id="advocatesList">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Advocate Performance Summary -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <h3>Team Performance Summary</h3>
            </div>
            <div class="card-body">
                <div id="performanceSummary">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <div class="footer">
            ¬© 2025 Cubictree (A Gaba Projects Private Limited Company)
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/common.js"></script>
    <script>
        let matterId = null;
        let currentMatter = null;
        let advocateAssignments = [];
        let matterTasks = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Get matter ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            matterId = urlParams.get('matterId');

            if (!matterId) {
                alert('No matter ID provided');
                window.history.back();
                return;
            }

            currentMatter = legalCRM.getById('matters', matterId);
            if (!currentMatter) {
                alert('Matter not found');
                window.history.back();
                return;
            }

            // Update page info
            document.getElementById('matterInfo').textContent = `Manage advocates for ${currentMatter.matterName}`;

            // Set default assignment date to today
            document.getElementById('assignmentDate').valueAsDate = new Date();

            // Load existing assignments
            loadAdvocates();

            // Load tasks for performance summary
            matterTasks = legalCRM.getMatterTasks(matterId);

            // Render performance summary
            renderPerformanceSummary();
        });

        function loadAdvocates() {
            advocateAssignments = legalCRM.getMatterAdvocates(matterId);
            renderAdvocatesList();
        }

        function renderAdvocatesList() {
            const container = document.getElementById('advocatesList');

            if (advocateAssignments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
                        <h3 style="margin-bottom: 8px;">No Advocates Assigned</h3>
                        <p>Click "Add Advocate" to assign advocates to this matter</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 16px;">
                    ${advocateAssignments.map(advocate => `
                        <div style="display: flex; align-items: start; justify-content: space-between; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: ${advocate.status === 'Active' ? '#ffffff' : '#f8fafc'};">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="font-weight: 600; font-size: 16px; color: #0f172a;">${advocate.advocateName}</div>
                                    <span class="badge" style="background: ${getRoleBadgeColor(advocate.role)};">${advocate.role}</span>
                                    ${advocate.isPrimary ? '<span class="badge" style="background: #3b82f6;">Primary</span>' : ''}
                                    <span class="badge" style="background: ${advocate.status === 'Active' ? '#10b981' : '#64748b'};">${advocate.status}</span>
                                </div>
                                <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">
                                    üìß ${advocate.email || 'N/A'} | üìû ${advocate.phone || 'N/A'}
                                </div>
                                ${advocate.practiceArea ? `<div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">üéØ ${advocate.practiceArea}</div>` : ''}
                                ${advocate.scopeOfWork ? `<div style="font-size: 13px; color: #475569; margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 4px;">${advocate.scopeOfWork}</div>` : ''}
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 8px;">
                                    Assigned: ${formatDate(advocate.assignmentDate)} | ${getAdvocateTaskCount(advocate.advocateName)} task(s)
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${advocate.status === 'Active' ?
                                    `<button onclick="markInactive('${advocate.id}')" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;">Mark Inactive</button>` :
                                    `<button onclick="markActive('${advocate.id}')" class="btn-primary" style="font-size: 12px; padding: 6px 12px;">Reactivate</button>`
                                }
                                <button onclick="removeAdvocate('${advocate.id}')" class="btn-secondary" style="font-size: 12px; padding: 6px 12px; color: #dc2626;">Remove</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderPerformanceSummary() {
            const container = document.getElementById('performanceSummary');

            if (advocateAssignments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b;">No advocates assigned yet</p>';
                return;
            }

            // Calculate performance metrics for each advocate
            const performance = advocateAssignments.map(advocate => {
                const tasksOwned = matterTasks.filter(t => t.owner === advocate.advocateName);
                const tasksAssigned = matterTasks.filter(t => t.assignee === advocate.advocateName);
                const allTasks = [...new Set([...tasksOwned, ...tasksAssigned])];

                const completedTasks = allTasks.filter(t => t.status === 'Completed').length;
                const delayedTasks = allTasks.filter(t =>
                    t.status !== 'Completed' &&
                    t.status !== 'Cancelled' &&
                    new Date(t.dueDate) < new Date()
                ).length;

                return {
                    name: advocate.advocateName,
                    role: advocate.role,
                    totalTasks: allTasks.length,
                    completedTasks: completedTasks,
                    delayedTasks: delayedTasks,
                    completionRate: allTasks.length > 0 ? Math.round((completedTasks / allTasks.length) * 100) : 0
                };
            });

            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Advocate</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Role</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569;">Total Tasks</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569;">Completed</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569;">Delayed</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569;">Completion Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${performance.map(p => `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 12px; font-weight: 500; color: #0f172a;">${p.name}</td>
                                    <td style="padding: 12px; color: #64748b;">${p.role}</td>
                                    <td style="padding: 12px; text-align: center; color: #64748b;">${p.totalTasks}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span style="color: #10b981; font-weight: 500;">${p.completedTasks}</span>
                                    </td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span style="color: ${p.delayedTasks > 0 ? '#dc2626' : '#64748b'}; font-weight: ${p.delayedTasks > 0 ? '500' : 'normal'};">${p.delayedTasks}</span>
                                    </td>
                                    <td style="padding: 12px; text-align: center;">
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            <div style="flex: 1; max-width: 100px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${p.completionRate}%; height: 100%; background: ${p.completionRate >= 70 ? '#10b981' : p.completionRate >= 40 ? '#f59e0b' : '#dc2626'}; transition: width 0.3s;"></div>
                                            </div>
                                            <span style="font-weight: 500; color: #0f172a;">${p.completionRate}%</span>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showAddAdvocateForm() {
            document.getElementById('addAdvocateForm').style.display = 'block';
            document.getElementById('advocateName').focus();
        }

        function hideAddAdvocateForm() {
            document.getElementById('addAdvocateForm').style.display = 'none';
            document.getElementById('advocateForm').reset();
            document.getElementById('assignmentDate').valueAsDate = new Date();
        }

        function saveAdvocate(event) {
            event.preventDefault();

            const newAdvocate = {
                id: `MADV-${Date.now()}`,
                matterId: matterId,
                advocateName: document.getElementById('advocateName').value,
                role: document.getElementById('advocateRole').value,
                email: document.getElementById('advocateEmail').value || null,
                phone: document.getElementById('advocatePhone').value || null,
                practiceArea: document.getElementById('practiceArea').value || null,
                assignmentDate: document.getElementById('assignmentDate').value,
                scopeOfWork: document.getElementById('scopeOfWork').value || null,
                isPrimary: document.getElementById('isPrimary').checked,
                status: 'Active',
                createdDate: new Date().toISOString().split('T')[0]
            };

            legalCRM.create('advocateAssignments', newAdvocate);

            alert('Advocate assigned successfully!');
            hideAddAdvocateForm();
            loadAdvocates();
            renderPerformanceSummary();
        }

        function markInactive(advocateId) {
            if (confirm('Mark this advocate as inactive? They will no longer appear in active assignments.')) {
                legalCRM.update('advocateAssignments', advocateId, { status: 'Inactive' });
                loadAdvocates();
            }
        }

        function markActive(advocateId) {
            legalCRM.update('advocateAssignments', advocateId, { status: 'Active' });
            loadAdvocates();
        }

        function removeAdvocate(advocateId) {
            const advocate = legalCRM.getById('advocateAssignments', advocateId);

            // Check if advocate has active tasks
            const advocateTasks = matterTasks.filter(t =>
                (t.owner === advocate.advocateName || t.assignee === advocate.advocateName) &&
                t.status !== 'Completed' &&
                t.status !== 'Cancelled'
            );

            if (advocateTasks.length > 0) {
                if (!confirm(`This advocate has ${advocateTasks.length} active task(s). Are you sure you want to remove them? You may need to reassign these tasks.`)) {
                    return;
                }
            }

            if (confirm(`Remove ${advocate.advocateName} from this matter?`)) {
                legalCRM.delete('advocateAssignments', advocateId);
                loadAdvocates();
                renderPerformanceSummary();
            }
        }

        function getAdvocateTaskCount(advocateName) {
            return matterTasks.filter(t =>
                t.owner === advocateName || t.assignee === advocateName
            ).length;
        }

        function getRoleBadgeColor(role) {
            const colors = {
                'Primary': '#8b5cf6',
                'Junior': '#3b82f6',
                'External': '#64748b'
            };
            return colors[role] || '#64748b';
        }

        function goBack() {
            window.location.href = `matter-details.html?id=${matterId}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    </script>
    <script src="js/navigation.js"></script>
</body>
</html>
