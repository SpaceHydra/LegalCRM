<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal CRM Portal - QC Review</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="logo-section">
            <div class="logo">LC</div>
            <div class="system-title">
                <h1>Legal CRM Portal</h1>
                <p>SNG & Partners - Business Development Platform</p>
            </div>
        </div>
        <div class="user-section">
            <div class="search-box">
                <span>üîç</span>
                <input type="text" id="searchBox" placeholder="Search QC items...">
            </div>
            <div class="notification-icon">
                <span style="font-size: 24px;">üîî</span>
                <div class="badge">0</div>
            </div>
            <div class="user-profile">
                <div class="user-avatar">PM</div>
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Prateek Mehta</div>
                    <div style="font-size: 11px; opacity: 0.8;">Senior Advocate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <!-- Core Modules - MVP Phase -->
        <div class="nav-section">
            <div class="nav-section-title">Core Modules (MVP)</div>
            <a href="dashboard.html" class="nav-item">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Dashboard</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="lead-management.html" class="nav-item">
                <div class="nav-icon">üéØ</div>
                <div class="nav-label">Lead Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="client-management.html" class="nav-item">
                <div class="nav-icon">üë•</div>
                <div class="nav-label">Client Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="project-management.html" class="nav-item">
                <div class="nav-icon">üìÅ</div>
                <div class="nav-label">Matter/Project Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Matter Management (Section B)</div>
            <a href="matter-list.html" class="nav-item">
                <div class="nav-icon">‚öñÔ∏è</div>
                <div class="nav-label">Matters</div>
                <div class="phase-badge phase2">Phase 2</div>
            </a>
            <a href="qc-review.html" class="nav-item active">
                <div class="nav-icon">‚úì</div>
                <div class="nav-label">QC Review</div>
                <div class="phase-badge phase2">Phase 2</div>
            </a>
            <a href="delivery-dashboard.html" class="nav-item">
                <div class="nav-icon">üìà</div>
                <div class="nav-label">Delivery Dashboard</div>
                <div class="phase-badge phase2">Phase 2</div>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Breadcrumb -->
        <div style="margin-bottom: 16px;">
            <a href="dashboard.html" style="color: #64748b; text-decoration: none;">Dashboard</a>
            <span style="color: #64748b;"> / </span>
            <a href="matter-list.html" style="color: #64748b; text-decoration: none;">Matters</a>
            <span style="color: #64748b;"> / </span>
            <span style="color: #0f172a; font-weight: 500;">QC Review</span>
        </div>

        <div class="page-header">
            <div>
                <h2>QC Review & Approvals</h2>
                <p>Review and approve deliverables before final submission to clients</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
            <div class="stat-card">
                <div class="stat-icon orange">‚è≥</div>
                <div class="stat-info">
                    <h3 id="pendingQC">0</h3>
                    <p>Pending Review</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">‚úì</div>
                <div class="stat-info">
                    <h3 id="approvedQC">0</h3>
                    <p>Approved</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">‚Ü©Ô∏è</div>
                <div class="stat-info">
                    <h3 id="changesRequiredQC">0</h3>
                    <p>Changes Required</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">üìä</div>
                <div class="stat-info">
                    <h3 id="totalQC">0</h3>
                    <p>Total Items</p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                    <div class="form-group">
                        <label>QC Status</label>
                        <select id="filterStatus" class="form-control" onchange="applyFilters()">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Changes Required">Changes Required</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deliverable Type</label>
                        <select id="filterType" class="form-control" onchange="applyFilters()">
                            <option value="">All Types</option>
                            <option value="TSR Final">TSR Final</option>
                            <option value="BPR Report">BPR Report</option>
                            <option value="EDD Report">EDD Report</option>
                            <option value="POSH Order">POSH Order</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Submitted By</label>
                        <select id="filterSubmittedBy" class="form-control" onchange="applyFilters()">
                            <option value="">All Submitters</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Reviewer</label>
                        <select id="filterReviewer" class="form-control" onchange="applyFilters()">
                            <option value="">All Reviewers</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- QC Items List -->
        <div class="card">
            <div class="card-header">
                <h3>QC Items Queue</h3>
            </div>
            <div class="card-body">
                <div id="qcItemsList">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            ¬© 2025 Cubictree (A Gaba Projects Private Limited Company)
        </div>
    </div>

    <!-- QC Review Modal -->
    <div id="qcReviewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
                <h3 style="margin: 0;">QC Review</h3>
            </div>
            <div style="padding: 24px;">
                <div class="form-group">
                    <label>Deliverable Name</label>
                    <input type="text" id="modalDeliverableName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Matter</label>
                    <input type="text" id="modalMatterName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Submitted By</label>
                    <input type="text" id="modalSubmittedBy" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>QC Decision *</label>
                    <select id="modalQCStatus" class="form-control">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Changes Required">Changes Required</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reviewer Comments</label>
                    <textarea id="modalReviewerComments" class="form-control" rows="4"></textarea>
                </div>
            </div>
            <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeQCModal()" class="btn-secondary">Cancel</button>
                <button onclick="saveQCReview()" class="btn-primary">Save Decision</button>
            </div>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/common.js"></script>
    <script>
        let allQCItems = [];
        let filteredQCItems = [];
        let currentQCItem = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadQCItems();
            loadFilterOptions();
            updateStats();
        });

        function loadQCItems() {
            allQCItems = legalCRM.get('qcItems');
            filteredQCItems = [...allQCItems];
            renderQCItemsList();
        }

        function loadFilterOptions() {
            // Load unique submitters
            const submitters = [...new Set(allQCItems.map(q => q.submittedBy))];
            const submitterFilter = document.getElementById('filterSubmittedBy');
            submitters.forEach(submitter => {
                const option = document.createElement('option');
                option.value = submitter;
                option.textContent = submitter;
                submitterFilter.appendChild(option);
            });

            // Load unique reviewers
            const reviewers = [...new Set(allQCItems.map(q => q.reviewer))];
            const reviewerFilter = document.getElementById('filterReviewer');
            reviewers.forEach(reviewer => {
                const option = document.createElement('option');
                option.value = reviewer;
                option.textContent = reviewer;
                reviewerFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            const typeFilter = document.getElementById('filterType').value;
            const submittedByFilter = document.getElementById('filterSubmittedBy').value;
            const reviewerFilter = document.getElementById('filterReviewer').value;

            filteredQCItems = allQCItems.filter(item => {
                if (statusFilter && item.qcStatus !== statusFilter) return false;
                if (typeFilter && item.deliverableType !== typeFilter) return false;
                if (submittedByFilter && item.submittedBy !== submittedByFilter) return false;
                if (reviewerFilter && item.reviewer !== reviewerFilter) return false;
                return true;
            });

            renderQCItemsList();
        }

        function renderQCItemsList() {
            const container = document.getElementById('qcItemsList');

            if (filteredQCItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No QC items found</p>';
                return;
            }

            container.innerHTML = filteredQCItems.map(item => {
                const statusClass = getQCStatusClass(item.qcStatus);
                const matter = legalCRM.getById('matters', item.matterId);
                const matterName = matter ? matter.matterName : 'Unknown';

                return `
                    <div class="task-list-item" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 4px 0; color: #0f172a;">${item.deliverableName}</h4>
                                <p style="margin: 0; color: #64748b; font-size: 13px;">Matter: ${matterName}</p>
                            </div>
                            <span class="${statusClass}">${item.qcStatus}</span>
                        </div>
                        <div style="margin: 12px 0; font-size: 12px; color: #64748b;">
                            <p style="margin: 4px 0;"><strong>Type:</strong> ${item.deliverableType}</p>
                            <p style="margin: 4px 0;"><strong>Submitted by:</strong> ${item.submittedBy} on ${formatDateTime(item.submittedOn)}</p>
                            <p style="margin: 4px 0;"><strong>Reviewer:</strong> ${item.reviewer}</p>
                            ${item.reviewerComments ? `<p style="margin: 4px 0;"><strong>Comments:</strong> ${item.reviewerComments}</p>` : ''}
                            ${item.qcDecisionDate ? `<p style="margin: 4px 0;"><strong>Decision Date:</strong> ${formatDateTime(item.qcDecisionDate)}</p>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="reviewQCItem('${item.id}')" class="btn-primary btn-sm">‚úì Review</button>
                            <button onclick="viewMatter('${item.matterId}')" class="btn-secondary btn-sm">View Matter</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getQCStatusClass(status) {
            const statusMap = {
                'Pending': 'status-new',
                'Approved': 'status-completed',
                'Changes Required': 'status-at-risk',
                'Rejected': 'status-cancelled'
            };
            return statusMap[status] || 'status-default';
        }

        function updateStats() {
            document.getElementById('totalQC').textContent = allQCItems.length;
            document.getElementById('pendingQC').textContent = allQCItems.filter(q => q.qcStatus === 'Pending').length;
            document.getElementById('approvedQC').textContent = allQCItems.filter(q => q.qcStatus === 'Approved').length;
            document.getElementById('changesRequiredQC').textContent = allQCItems.filter(q => q.qcStatus === 'Changes Required').length;
        }

        function reviewQCItem(qcItemId) {
            currentQCItem = legalCRM.getById('qcItems', qcItemId);

            if (!currentQCItem) {
                alert('QC item not found');
                return;
            }

            const matter = legalCRM.getById('matters', currentQCItem.matterId);

            document.getElementById('modalDeliverableName').value = currentQCItem.deliverableName;
            document.getElementById('modalMatterName').value = matter ? matter.matterName : 'Unknown';
            document.getElementById('modalSubmittedBy').value = currentQCItem.submittedBy;
            document.getElementById('modalQCStatus').value = currentQCItem.qcStatus;
            document.getElementById('modalReviewerComments').value = currentQCItem.reviewerComments || '';

            document.getElementById('qcReviewModal').style.display = 'flex';
        }

        function closeQCModal() {
            document.getElementById('qcReviewModal').style.display = 'none';
            currentQCItem = null;
        }

        function saveQCReview() {
            if (!currentQCItem) return;

            const qcStatus = document.getElementById('modalQCStatus').value;
            const reviewerComments = document.getElementById('modalReviewerComments').value;

            const updateData = {
                qcStatus: qcStatus,
                reviewerComments: reviewerComments,
                qcDecisionDate: new Date().toISOString()
            };

            legalCRM.update('qcItems', currentQCItem.id, updateData);

            // If approved, mark document as final deliverable
            if (qcStatus === 'Approved' && currentQCItem.documentId) {
                legalCRM.update('matterDocuments', currentQCItem.documentId, { isFinalDeliverable: true });
            }

            alert('QC decision saved successfully!');
            closeQCModal();
            loadQCItems();
            updateStats();
        }

        function viewMatter(matterId) {
            window.location.href = `matter-details.html?id=${matterId}`;
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();

            filteredQCItems = allQCItems.filter(item => {
                return item.id.toLowerCase().includes(searchTerm) ||
                       item.deliverableName.toLowerCase().includes(searchTerm) ||
                       item.deliverableType.toLowerCase().includes(searchTerm) ||
                       item.submittedBy.toLowerCase().includes(searchTerm);
            });

            renderQCItemsList();
        });
    </script>
    <script src="js/navigation.js"></script>
</body>
</html>
