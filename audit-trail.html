<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Trail - Legal CRM</title>
    <link rel="stylesheet" href="css/common-styles.css">
    <style>
        /* Audit Trail specific styles */
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-item label {
            display: block;
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }

        .summary-card h3 {
            font-size: 32px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .summary-card p {
            color: #7f8c8d;
            font-size: 13px;
        }

        /* Timeline */
        .timeline {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .timeline-date-group {
            margin-bottom: 30px;
        }

        .timeline-date-header {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            transition: all 0.2s ease;
        }

        .timeline-item:hover {
            background: #ecf0f1;
            transform: translateX(5px);
        }

        .timeline-item.created {
            border-left-color: #27ae60;
        }

        .timeline-item.updated {
            border-left-color: #3498db;
        }

        .timeline-item.deleted {
            border-left-color: #e74c3c;
        }

        .timeline-item.conversion {
            border-left-color: #9b59b6;
        }

        .timeline-item.payment {
            border-left-color: #f39c12;
        }

        .timeline-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 24px;
        }

        .timeline-icon.created {
            background: #d4edda;
            color: #27ae60;
        }

        .timeline-icon.updated {
            background: #d1ecf1;
            color: #3498db;
        }

        .timeline-icon.deleted {
            background: #f8d7da;
            color: #e74c3c;
        }

        .timeline-icon.conversion {
            background: #e1d5e7;
            color: #9b59b6;
        }

        .timeline-icon.payment {
            background: #fff3cd;
            color: #f39c12;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-content h4 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .timeline-content p {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .timeline-meta {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #95a5a6;
        }

        .timeline-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .activity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
        }

        .activity-badge.created {
            background: #d4edda;
            color: #27ae60;
        }

        .activity-badge.updated {
            background: #d1ecf1;
            color: #3498db;
        }

        .activity-badge.deleted {
            background: #f8d7da;
            color: #e74c3c;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .export-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
            transition: transform 0.2s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination button:hover {
            background: #ecf0f1;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            font-size: 14px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="logo-section">
            <div class="logo">LC</div>
            <div class="system-title">
                <h1>Legal CRM Portal</h1>
                <p>SNG & Partners - Business Development Platform</p>
            </div>
        </div>
        <div class="user-section">
            <div class="search-box">
                <span>üîç</span>
                <input type="text" placeholder="Search activities...">
            </div>
            <div class="notification-icon">
                <span style="font-size: 24px;">üîî</span>
                <div class="badge" id="notificationCount">0</div>
            </div>
            <div class="user-profile">
                <div class="user-avatar">PM</div>
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Prateek Mehta</div>
                    <div style="font-size: 11px; opacity: 0.8;">Senior Advocate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="nav-section">
            <div class="nav-section-title">Core Modules (MVP)</div>
            <a href="dashboard.html" class="nav-item">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Dashboard</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="lead-management.html" class="nav-item">
                <div class="nav-icon">üéØ</div>
                <div class="nav-label">Lead Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="client-management.html" class="nav-item">
                <div class="nav-icon">üë•</div>
                <div class="nav-label">Client Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="project-management.html" class="nav-item">
                <div class="nav-icon">üìÅ</div>
                <div class="nav-label">Matter/Project Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="task-management.html" class="nav-item">
                <div class="nav-icon">‚úÖ</div>
                <div class="nav-label">Task Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="document-management.html" class="nav-item">
                <div class="nav-icon">üìÑ</div>
                <div class="nav-label">Document Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="user-management.html" class="nav-item">
                <div class="nav-icon">üë§</div>
                <div class="nav-label">User & Role Management</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="reporting.html" class="nav-item">
                <div class="nav-icon">üìà</div>
                <div class="nav-label">Basic Reporting</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="billing.html" class="nav-item">
                <div class="nav-icon">üí∞</div>
                <div class="nav-label">Billing & Revenue</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
            <a href="calendar.html" class="nav-item">
                <div class="nav-icon">üìÜ</div>
                <div class="nav-label">Calendar Integration</div>
                <div class="phase-badge mvp">MVP</div>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Phase 2</div>
            <a href="advocates-management.html" class="nav-item">
                <div class="nav-icon">üë®‚Äç‚öñÔ∏è</div>
                <div class="nav-label">Empaneled Advocates</div>
                <div class="phase-badge phase2">Phase 2</div>
            </a>
            <a href="audit-trail.html" class="nav-item active">
                <div class="nav-icon">üîç</div>
                <div class="nav-label">Audit Trail</div>
                <div class="phase-badge phase2">Phase 2</div>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h2>Audit Trail</h2>
            <button class="export-btn" onclick="exportAuditLog()">
                <span>üì•</span> Export to CSV
            </button>
        </div>

        <!-- Stats Summary -->
        <div class="stats-summary">
            <div class="summary-card">
                <h3 id="totalActivities">0</h3>
                <p>Total Activities</p>
            </div>
            <div class="summary-card">
                <h3 id="todayActivities">0</h3>
                <p>Activities Today</p>
            </div>
            <div class="summary-card">
                <h3 id="thisWeekActivities">0</h3>
                <p>This Week</p>
            </div>
            <div class="summary-card">
                <h3 id="uniqueUsers">0</h3>
                <p>Active Users</p>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-item">
                    <label>Activity Type</label>
                    <select id="filterType" onchange="loadAuditTrail()">
                        <option value="">All Types</option>
                        <option value="created">Created</option>
                        <option value="updated">Updated</option>
                        <option value="deleted">Deleted</option>
                        <option value="conversion">Conversion</option>
                        <option value="payment">Payment</option>
                        <option value="upload">Upload</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>User</label>
                    <select id="filterUser" onchange="loadAuditTrail()">
                        <option value="">All Users</option>
                        <!-- Dynamically populated -->
                    </select>
                </div>
                <div class="filter-item">
                    <label>Date From</label>
                    <input type="date" id="dateFrom" onchange="loadAuditTrail()">
                </div>
                <div class="filter-item">
                    <label>Date To</label>
                    <input type="date" id="dateTo" onchange="loadAuditTrail()">
                </div>
                <div class="filter-item">
                    <label>Search</label>
                    <input type="text" id="searchActivity" placeholder="Search activities..." onkeyup="loadAuditTrail()">
                </div>
            </div>
        </div>

        <!-- Audit Trail Timeline -->
        <div class="timeline" id="auditTimeline">
            <!-- Dynamic content loaded here -->
        </div>

        <!-- Pagination -->
        <div class="pagination" id="paginationControls">
            <!-- Dynamic pagination controls -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/data.js"></script>
    <script src="js/common.js"></script>
    <script>
        let currentPage = 1;
        const itemsPerPage = 20;

        // Load audit trail on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserFilter();
            loadAuditTrail();
            updateStats();
        });

        function loadUserFilter() {
            const activities = legalCRM.get('activities');
            const uniqueUsers = [...new Set(activities.map(a => a.user))];

            const userFilter = document.getElementById('filterUser');
            uniqueUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userFilter.appendChild(option);
            });
        }

        function updateStats() {
            const activities = legalCRM.get('activities');
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // Total activities
            document.getElementById('totalActivities').textContent = activities.length;

            // Today's activities
            const todayCount = activities.filter(a =>
                a.timestamp && a.timestamp.startsWith(today)
            ).length;
            document.getElementById('todayActivities').textContent = todayCount;

            // This week's activities
            const weekCount = activities.filter(a =>
                a.timestamp && a.timestamp >= weekAgo
            ).length;
            document.getElementById('thisWeekActivities').textContent = weekCount;

            // Unique users
            const uniqueUsers = new Set(activities.map(a => a.user)).size;
            document.getElementById('uniqueUsers').textContent = uniqueUsers;
        }

        function loadAuditTrail() {
            const activities = legalCRM.get('activities');

            // Get filter values
            const filterType = document.getElementById('filterType').value;
            const filterUser = document.getElementById('filterUser').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const searchTerm = document.getElementById('searchActivity').value.toLowerCase();

            // Apply filters
            let filteredActivities = activities.filter(activity => {
                const matchesType = !filterType || activity.type.includes(filterType);
                const matchesUser = !filterUser || activity.user === filterUser;
                const matchesDateFrom = !dateFrom || (activity.timestamp && activity.timestamp >= dateFrom);
                const matchesDateTo = !dateTo || (activity.timestamp && activity.timestamp <= dateTo + 'T23:59:59');
                const matchesSearch = !searchTerm ||
                    activity.title.toLowerCase().includes(searchTerm) ||
                    activity.description.toLowerCase().includes(searchTerm);

                return matchesType && matchesUser && matchesDateFrom && matchesDateTo && matchesSearch;
            });

            // Sort by timestamp (newest first)
            filteredActivities.sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            // Pagination
            const totalPages = Math.ceil(filteredActivities.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedActivities = filteredActivities.slice(startIndex, endIndex);

            // Group by date
            const groupedByDate = {};
            paginatedActivities.forEach(activity => {
                const date = activity.timestamp ? activity.timestamp.split('T')[0] : 'Unknown';
                if (!groupedByDate[date]) {
                    groupedByDate[date] = [];
                }
                groupedByDate[date].push(activity);
            });

            const container = document.getElementById('auditTimeline');

            if (Object.keys(groupedByDate).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Activities Found</h3>
                        <p>No audit trail entries match your search criteria</p>
                    </div>
                `;
                document.getElementById('paginationControls').innerHTML = '';
                return;
            }

            // Render timeline
            container.innerHTML = Object.keys(groupedByDate).map(date => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const activitiesHtml = groupedByDate[date].map(activity => {
                    const activityType = getActivityType(activity.type);
                    const icon = getActivityIcon(activity.type);
                    const timeAgo = getTimeAgo(activity.timestamp);
                    const timestamp = new Date(activity.timestamp).toLocaleTimeString('en-IN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return `
                        <div class="timeline-item ${activityType}">
                            <div class="timeline-icon ${activityType}">${icon}</div>
                            <div class="timeline-content">
                                <h4>${activity.title}</h4>
                                <p>${activity.description}</p>
                                <div class="timeline-meta">
                                    <span>üë§ ${activity.user}</span>
                                    <span>üïê ${timestamp}</span>
                                    <span>üìÖ ${timeAgo}</span>
                                    ${activity.relatedId ? `<span>üîó ${activity.relatedId}</span>` : ''}
                                </div>
                                <span class="activity-badge ${activityType}">${activityType.toUpperCase()}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="timeline-date-group">
                        <div class="timeline-date-header">${formattedDate}</div>
                        ${activitiesHtml}
                    </div>
                `;
            }).join('');

            // Render pagination
            renderPagination(totalPages, filteredActivities.length);
        }

        function renderPagination(totalPages, totalItems) {
            if (totalPages <= 1) {
                document.getElementById('paginationControls').innerHTML = '';
                return;
            }

            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            document.getElementById('paginationControls').innerHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    ‚Üê Previous
                </button>
                <span class="page-info">
                    Showing ${startItem}-${endItem} of ${totalItems} activities
                </span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Next ‚Üí
                </button>
            `;
        }

        function changePage(page) {
            currentPage = page;
            loadAuditTrail();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getActivityType(type) {
            if (type.includes('created')) return 'created';
            if (type.includes('updated')) return 'updated';
            if (type.includes('deleted')) return 'deleted';
            if (type.includes('conversion')) return 'conversion';
            if (type.includes('payment')) return 'payment';
            return 'updated';
        }

        function getActivityIcon(type) {
            if (type.includes('created')) return '‚úì';
            if (type.includes('updated')) return 'üìù';
            if (type.includes('deleted')) return 'üóëÔ∏è';
            if (type.includes('conversion')) return 'üîÑ';
            if (type.includes('payment')) return 'üí∞';
            if (type.includes('document') || type.includes('upload')) return 'üìÑ';
            if (type.includes('overdue')) return '‚ö†Ô∏è';
            return '‚ÑπÔ∏è';
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown';

            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays > 0) {
                return diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
            } else if (diffHours > 0) {
                return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
            } else if (diffMins > 0) {
                return diffMins === 1 ? '1 minute ago' : `${diffMins} minutes ago`;
            } else {
                return 'Just now';
            }
        }

        function exportAuditLog() {
            const activities = legalCRM.get('activities');

            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Timestamp,Type,Title,Description,User,Related ID\n";

            activities.forEach(activity => {
                const row = [
                    activity.id,
                    activity.timestamp,
                    activity.type,
                    `"${activity.title}"`,
                    `"${activity.description}"`,
                    activity.user,
                    activity.relatedId || ''
                ].join(',');
                csvContent += row + "\n";
            });

            // Download file
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `audit-trail-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('Audit trail exported successfully!');
        }
    </script>
</body>
</html>
