<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal CRM Portal - Delivery Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .kpi-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #0f172a;
            margin: 8px 0;
        }
        .kpi-label {
            font-size: 13px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }
        .kpi-trend {
            font-size: 12px;
            margin-top: 8px;
        }
        .kpi-trend.up {
            color: #10b981;
        }
        .kpi-trend.down {
            color: #ef4444;
        }
        .workload-bar {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            overflow: hidden;
            margin-top: 8px;
        }
        .workload-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .workload-fill.low {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        .workload-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }
        .workload-fill.high {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="logo-section">
            <div class="logo">LC</div>
            <div class="system-title">
                <h1>Legal CRM Portal</h1>
                <p>SNG & Partners - Business Development Platform</p>
            </div>
        </div>
        <div class="user-section">
            <div class="user-profile">
                <div class="user-avatar">PM</div>
                <div>
                    <div style="font-weight: 600; font-size: 14px;">Prateek Mehta</div>
                    <div style="font-size: 11px; opacity: 0.8;">Senior Advocate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="nav-section">
            <div class="nav-section-title">Matter Management</div>
            <a href="matter-list.html" class="nav-item">
                <div class="nav-icon">‚öñÔ∏è</div>
                <div class="nav-label">Matters</div>
            </a>
            <a href="qc-review.html" class="nav-item">
                <div class="nav-icon">‚úì</div>
                <div class="nav-label">QC Review</div>
            </a>
            <a href="delivery-dashboard.html" class="nav-item active">
                <div class="nav-icon">üìà</div>
                <div class="nav-label">Delivery Dashboard</div>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <div>
                <h2>Delivery Dashboard</h2>
                <p>Monitor matter delivery performance, SLA compliance, and team workload</p>
            </div>
            <div style="display: flex; gap: 8px;">
                <select id="timeFilter" class="form-control" style="width: 150px;" onchange="applyTimeFilter()">
                    <option value="current">Current Period</option>
                    <option value="last-month">Last Month</option>
                    <option value="last-quarter">Last Quarter</option>
                    <option value="all">All Time</option>
                </select>
                <button onclick="exportReport()" class="btn-secondary">üì• Export Report</button>
            </div>
        </div>

        <!-- Overall KPIs -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px;">
            <div class="kpi-card">
                <div class="kpi-label">Active Matters</div>
                <div class="kpi-value" id="kpiActiveMatters">0</div>
                <div class="kpi-trend up" id="kpiActiveMattersChange">‚Äî</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">SLA Compliance</div>
                <div class="kpi-value" id="kpiSLACompliance">0%</div>
                <div class="kpi-trend up" id="kpiSLAChange">‚Äî</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Open Tasks</div>
                <div class="kpi-value" id="kpiOpenTasks">0</div>
                <div class="kpi-trend" id="kpiOpenTasksChange">‚Äî</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Delayed Tasks</div>
                <div class="kpi-value" id="kpiDelayedTasks">0</div>
                <div class="kpi-trend down" id="kpiDelayedTasksChange">‚Äî</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Pending QC</div>
                <div class="kpi-value" id="kpiPendingQC">0</div>
                <div class="kpi-trend" id="kpiPendingQCChange">‚Äî</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
            <!-- Matters by Status -->
            <div class="card">
                <div class="card-header">
                    <h3>Matters by Status</h3>
                </div>
                <div class="card-body">
                    <div id="mattersByStatus">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Matters by Practice Area -->
            <div class="card">
                <div class="card-header">
                    <h3>Matters by Practice Area</h3>
                </div>
                <div class="card-body">
                    <div id="mattersByPracticeArea">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Advocate Performance -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3>Advocate Performance & Workload</h3>
            </div>
            <div class="card-body">
                <div id="advocateWorkload">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Matters at Risk -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3>Matters at Risk</h3>
            </div>
            <div class="card-body">
                <div id="mattersAtRisk">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h3>Recent Activity</h3>
            </div>
            <div class="card-body">
                <div id="recentActivity">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            ¬© 2025 Cubictree (A Gaba Projects Private Limited Company)
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
        });

        function loadDashboard() {
            loadKPIs();
            loadMattersByStatus();
            loadMattersByPracticeArea();
            loadAdvocateWorkload();
            loadMattersAtRisk();
            loadRecentActivity();
        }

        function loadKPIs() {
            const stats = legalCRM.getMatterStats();

            document.getElementById('kpiActiveMatters').textContent = stats.activeMatters;
            document.getElementById('kpiSLACompliance').textContent = stats.slaCompliancePercent + '%';
            document.getElementById('kpiOpenTasks').textContent = stats.openTasks;
            document.getElementById('kpiDelayedTasks').textContent = stats.delayedTasks;
            document.getElementById('kpiPendingQC').textContent = stats.pendingQC;

            // Simulated trends (in real app, compare with previous period)
            document.getElementById('kpiActiveMattersChange').textContent = '‚Üë 12% vs last period';
            document.getElementById('kpiSLAChange').textContent = stats.slaCompliancePercent >= 90 ? '‚Üë On track' : '‚Üì Below target';
            document.getElementById('kpiOpenTasksChange').textContent = '‚Üí Stable';
            document.getElementById('kpiDelayedTasksChange').textContent = stats.delayedTasks > 0 ? '‚Üì Needs attention' : '‚úì All on track';
            document.getElementById('kpiPendingQCChange').textContent = stats.pendingQC + ' items in queue';
        }

        function loadMattersByStatus() {
            const matters = legalCRM.get('matters');
            const statusCounts = {};

            matters.forEach(matter => {
                statusCounts[matter.status] = (statusCounts[matter.status] || 0) + 1;
            });

            const totalMatters = matters.length;
            let html = '';

            Object.keys(statusCounts).forEach(status => {
                const count = statusCounts[status];
                const percentage = Math.round((count / totalMatters) * 100);
                const statusClass = getStatusClass(status);

                html += `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span><span class="${statusClass}">${status}</span></span>
                            <span style="font-weight: 600;">${count} (${percentage}%)</span>
                        </div>
                        <div class="workload-bar">
                            <div class="workload-fill ${getWorkloadClass(percentage)}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('mattersByStatus').innerHTML = html || '<p style="text-align: center; color: #64748b;">No data available</p>';
        }

        function loadMattersByPracticeArea() {
            const mattersByArea = legalCRM.getMattersByPracticeArea();

            if (mattersByArea.length === 0) {
                document.getElementById('mattersByPracticeArea').innerHTML = '<p style="text-align: center; color: #64748b;">No data available</p>';
                return;
            }

            const html = mattersByArea.map(area => {
                return `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">${area.practiceArea}</span>
                            <span style="color: #64748b;">${area.count} matters</span>
                        </div>
                        <div style="display: flex; gap: 8px; font-size: 12px; color: #64748b;">
                            <span>In Execution: ${area.inExecution}</span>
                            <span>At Risk: ${area.atRisk}</span>
                            <span>Completed: ${area.completed}</span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('mattersByPracticeArea').innerHTML = html;
        }

        function loadAdvocateWorkload() {
            const workloadData = legalCRM.getAdvocateWorkload();

            if (workloadData.length === 0) {
                document.getElementById('advocateWorkload').innerHTML = '<p style="text-align: center; color: #64748b;">No data available</p>';
                return;
            }

            // Sort by open tasks (descending)
            workloadData.sort((a, b) => b.openTasks - a.openTasks);

            const maxTasks = Math.max(...workloadData.map(w => w.openTasks));

            const html = workloadData.map(workload => {
                const percentage = maxTasks > 0 ? (workload.openTasks / maxTasks) * 100 : 0;
                const workloadClass = workload.openTasks <= 3 ? 'low' :
                                     workload.openTasks <= 6 ? 'medium' : 'high';

                return `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">üë®‚Äç‚öñÔ∏è ${workload.name}</span>
                            <span style="font-size: 12px; color: #64748b;">
                                ${workload.activeMatters} matters | ${workload.openTasks} open tasks | ${workload.delayedTasks} delayed
                            </span>
                        </div>
                        <div class="workload-bar">
                            <div class="workload-fill ${workloadClass}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('advocateWorkload').innerHTML = html;
        }

        function loadMattersAtRisk() {
            const matters = legalCRM.get('matters');
            const atRiskMatters = matters.filter(m => m.status === 'At Risk');

            if (atRiskMatters.length === 0) {
                document.getElementById('mattersAtRisk').innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No matters at risk</p>';
                return;
            }

            const html = atRiskMatters.map(matter => {
                return `
                    <div class="task-list-item" onclick="window.location.href='matter-details.html?id=${matter.id}'" style="margin-bottom: 12px; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <h4 style="margin: 0 0 4px 0; color: #0f172a;">${matter.id} - ${matter.matterName}</h4>
                                <p style="margin: 0; color: #64748b; font-size: 13px;">Client: ${matter.clientName} | Owner: ${matter.internalMatterOwner}</p>
                            </div>
                            <span class="status-at-risk">${matter.status}</span>
                        </div>
                        ${matter.riskFlags && matter.riskFlags.length > 0 ? `
                            <div style="margin-top: 8px;">
                                ${matter.riskFlags.map(flag => `<span class="risk-tag">‚ö†Ô∏è ${flag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('mattersAtRisk').innerHTML = html;
        }

        function loadRecentActivity() {
            const activities = legalCRM.get('activities').slice(0, 5);

            if (activities.length === 0) {
                document.getElementById('recentActivity').innerHTML = '<p style="text-align: center; color: #64748b;">No recent activities</p>';
                return;
            }

            const html = activities.map(activity => {
                const iconClass = activity.type.includes('success') ? 'success' :
                                 activity.type.includes('warning') ? 'warning' :
                                 activity.type.includes('error') ? 'error' : 'info';

                const icon = activity.type.includes('conversion') ? '‚úì' :
                            activity.type.includes('document') ? 'üìÑ' :
                            activity.type.includes('overdue') ? '‚ö†Ô∏è' :
                            activity.type.includes('payment') ? 'üí∞' : '‚ÑπÔ∏è';

                return `
                    <div class="timeline-item">
                        <div class="timeline-icon ${iconClass}">${icon}</div>
                        <div class="timeline-content">
                            <h4>${activity.title}</h4>
                            <p>${activity.description}</p>
                            <div class="timeline-time">${getTimeAgo(activity.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('recentActivity').innerHTML = html;
        }

        function getStatusClass(status) {
            const statusMap = {
                'New': 'status-new',
                'In Execution': 'status-in-progress',
                'At Risk': 'status-at-risk',
                'Completed': 'status-completed',
                'On Hold': 'status-on-hold',
                'Cancelled': 'status-cancelled'
            };
            return statusMap[status] || 'status-default';
        }

        function getWorkloadClass(percentage) {
            if (percentage <= 33) return 'low';
            if (percentage <= 66) return 'medium';
            return 'high';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays > 0) {
                return diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
            } else if (diffHours > 0) {
                return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
            } else {
                return 'Just now';
            }
        }

        function applyTimeFilter() {
            // TODO: Implement time period filtering
            loadDashboard();
        }

        function exportReport() {
            alert('Export functionality to be implemented');
        }
    </script>
    <script src="js/navigation.js"></script>
</body>
</html>
